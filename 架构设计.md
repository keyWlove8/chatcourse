# 🏗️ 系统架构设计

AI聊天系统的整体架构设计、模块划分和技术选型说明。

## 📋 项目概述

AI聊天系统是一个基于大语言模型的智能聊天平台，支持多角色对话、语音交互、知识库管理和权限控制。系统采用微服务架构，前后端分离设计，支持容器化部署。

## 🎯 核心功能

### 🤖 智能对话
- **多角色支持**: 创建自定义AI角色，每个角色具有独特的性格和对话风格
- **上下文记忆**: 支持多轮对话，保持对话上下文连贯性
- **知识库集成**: 基于RAG技术，支持上传文档进行知识问答
- **多模态交互**: 支持文本、图片、语音多种输入方式

### 🎭 角色管理
- **角色创建**: 自定义角色名称、描述、头像和系统提示词
- **音色配置**: 为每个角色配置独特的语音合成音色
- **权限控制**: 支持公开/私有角色，管理员可管理所有角色

### 🎤 语音对话功能
- **语音输入Asr**: 支持实时语音转文字
- **语音合成Tts**: AI回复可转换为语音播放
- **多语言支持**: 支持多种语言的语音识别和合成

### 📚 知识库管理
- **文档上传**: 支持PDF、Word、TXT等多种格式
- **智能检索**: 基于向量数据库的语义搜索
- **权限控制**: 管理员可创建知识库，普通用户可查看使用

## 🏗️ 系统架构

### 微服务架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端服务      │    │   代理服务      │    │   后端服务      │
│   Vue.js        │◄──►│   Node.js       │◄──►│   Spring Boot   │
│   (端口3000)    │    │   (端口8080)    │    │   (端口8031)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   静态文件服务  │
                       │   Spring Boot   │
                       │   (端口9000)    │
                       └─────────────────┘
```

### 服务职责划分

#### 前端服务 (Vue.js)
- **用户界面**: 提供友好的用户交互界面
- **状态管理**: 使用Pinia管理应用状态
- **路由管理**: 使用Vue Router处理页面路由
- **组件化**: 模块化的Vue组件设计
- **响应式设计**: 支持多设备适配

#### 代理服务 (Node.js)
- **统一入口**: 作为所有请求的统一入口点
- **请求路由**: 将请求路由到相应的后端服务
- **静态文件**: 代理静态文件请求
- **负载均衡**: 支持多实例负载均衡
- **缓存管理**: 实现请求缓存机制

#### AI聊天服务 (Spring Boot)
- **对话处理**: 处理用户与AI的对话逻辑
- **角色管理**: 管理AI角色的创建和配置
- **知识库**: 处理知识库的CRUD操作
- **权限控制**: 实现基于JWT的权限验证
- **AI集成**: 集成OpenAI API和LangChain4j

#### 静态文件服务 (Spring Boot)
- **文件存储**: 管理用户上传的文件
- **文件服务**: 提供文件下载和访问服务
- **文件处理**: 处理文件格式转换和预览
- **权限控制**: 控制文件访问权限

## 🛠️ 技术栈

### 前端技术
- **Vue 3**: 渐进式JavaScript框架
- **Pinia**: 状态管理
- **Vue Router**: 路由管理
- **Tailwind CSS**: 样式框架
- **Font Awesome**: 图标库
- **Axios**: HTTP客户端

### 后端技术
- **Spring Boot 3.2**: 主框架
- **Jwt Token**: 安全认证
- **MyBatis Plus**: ORM框架
- **LangChain4j**: AI集成框架
- **OpenAI API**: 大语言模型
- **Pinecone**: 向量数据库
- **Redis**: 缓存和会话存储
- **MySQL**: 关系型数据库

### 部署技术
- **Docker**: 容器化部署
- **Docker Compose**: 多容器编排
- **Maven**: 项目构建
- **pnpm**: 前端包管理

## 📁 项目结构

```
chat2project/
├── ai-chat-frontend/           # 前端项目
│   ├── aichat-frontend/        # Vue.js前端应用
│   │   ├── src/
│   │   │   ├── components/     # Vue组件
│   │   │   ├── views/          # 页面视图
│   │   │   ├── store/          # Pinia状态管理
│   │   │   ├── services/       # API服务
│   │   │   ├── utils/          # 工具函数
│   │   │   └── router/         # 路由配置
│   │   ├── public/             # 静态资源
│   │   └── package.json        # 依赖配置
│   └── aichat-node-proxy/      # Node.js代理服务
│       ├── server.js           # 代理服务器
│       └── package.json        # 依赖配置
├── ai-chat-web/               # 后端项目
│   ├── ai-chat/               # AI聊天服务
│   │   ├── src/main/java/com/k8/
│   │   │   ├── controller/     # 控制器层
│   │   │   ├── service/        # 服务层
│   │   │   ├── entity/         # 实体类
│   │   │   ├── mapper/         # 数据访问层
│   │   │   ├── dto/            # 数据传输对象
│   │   │   └── vo/             # 视图对象
│   │   └── src/main/resources/
│   │       ├── application.yaml # 配置文件
│   │       └── sql/            # SQL脚本
│   ├── ai-static/             # 静态文件服务
│   ├── ai-common/             # 公共模块
│   └── ai-boot/               # 启动器模块
├── docker-compose.yml         # Docker编排配置
├── Dockerfile                 # 镜像构建文件
├── build.sh                   # 构建脚本
└── start-all-services.sh      # 启动脚本
```

## 🔄 数据流设计

### 用户请求流程
```
用户请求 → 代理服务 → 路由分发 → 后端服务 → 数据库/缓存 → 返回响应
```

### 语音对话流程
```
语音输入 → 前端录音 → 语音检测 → 音频处理 → 发送请求 → AI处理 → 语音合成 → 播放回复
```

### 知识库查询流程
```
用户问题 → 向量化 → 向量搜索 → 检索相关文档 → 上下文构建 → AI回答 → 返回结果
```

## 🗄️ 数据库设计

### 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'user') DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 角色表 (characters)
```sql
CREATE TABLE characters (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    system_prompt TEXT,
    avatar_url VARCHAR(500),
    voice_id VARCHAR(100),
    is_public BOOLEAN DEFAULT FALSE,
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 对话表 (conversations)
```sql
CREATE TABLE conversations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    character_id BIGINT NOT NULL,
    title VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 消息表 (messages)
```sql
CREATE TABLE messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    conversation_id BIGINT NOT NULL,
    role ENUM('user', 'assistant') NOT NULL,
    content TEXT NOT NULL,
    message_type ENUM('text', 'image', 'voice') DEFAULT 'text',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 🔐 权限系统设计

### 角色权限矩阵

| 功能 | 管理员 | 普通用户 |
|------|--------|----------|
| 创建角色 | ✅ | ❌ |
| 管理角色 | ✅ | ❌ |
| 创建知识库 | ✅ | ❌ |
| 上传文档 | ✅ | ❌ |
| 使用角色聊天 | ✅ | ✅ |
| 查看知识库 | ✅ | ✅ |
| 使用知识库问答 | ✅ | ✅ |

### 权限控制实现
- **前端**: 基于Vue组件的权限控制
- **后端**: 基于JWT的API权限验证
- **数据库**: 基于用户角色的数据访问控制

## 🚀 性能优化

### 前端优化
- **代码分割**: 按需加载组件
- **缓存策略**: 合理使用浏览器缓存
- **图片优化**: 压缩和懒加载
- **CDN加速**: 静态资源CDN分发

### 后端优化
- **数据库索引**: 优化查询性能
- **Redis缓存**: 缓存热点数据
- **连接池**: 数据库连接池管理
- **异步处理**: 非阻塞IO操作

### 系统优化
- **负载均衡**: 多实例部署
- **监控告警**: 实时监控系统状态
- **日志管理**: 结构化日志记录
- **容错机制**: 服务降级和熔断

## 🔧 扩展性设计

### 水平扩展
- **无状态服务**: 支持多实例部署
- **数据库分片**: 支持数据分片存储
- **缓存集群**: Redis集群部署
- **负载均衡**: 支持负载均衡器

### 功能扩展
- **插件系统**: 支持功能插件扩展
- **API网关**: 统一的API管理
- **消息队列**: 异步消息处理
- **微服务拆分**: 进一步微服务化

## 📊 监控和运维

### 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: 请求量、响应时间、错误率
- **业务指标**: 用户活跃度、对话量、知识库使用量

### 日志管理
- **结构化日志**: JSON格式日志
- **日志聚合**: 集中化日志收集
- **日志分析**: 基于ELK的日志分析
- **告警机制**: 异常情况自动告警

## 🔄 版本管理

### 版本策略
- **语义化版本**: 遵循SemVer规范
- **分支管理**: Git Flow工作流
- **发布流程**: 自动化CI/CD流程
- **回滚机制**: 支持快速回滚

### 更新策略
- **灰度发布**: 逐步发布新版本
- **蓝绿部署**: 零停机更新
- **数据库迁移**: 版本化数据库变更
- **配置管理**: 环境配置分离

## 📞 技术支持

### 开发规范
- **代码规范**: 统一的代码风格
- **文档规范**: 完善的API文档
- **测试规范**: 单元测试和集成测试
- **部署规范**: 标准化的部署流程

### 问题处理
- **问题分类**: 按优先级和类型分类
- **处理流程**: 标准化的问题处理流程
- **知识库**: 常见问题知识库
- **社区支持**: 开源社区支持
