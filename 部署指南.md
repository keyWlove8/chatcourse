# 🚀 部署指南

AI聊天系统的完整部署和运行指南。

## 📋 环境要求

### 系统要求
- **操作系统**: Linux/Windows/macOS
- **内存**: 建议至少4GB
- **磁盘空间**: 建议至少10GB可用空间
- **网络**: 需要访问OpenAI API

### 软件依赖
- **Java 21+**: 后端运行环境
- **Node.js 18+**: 前端开发环境
- **Docker & Docker Compose**: 容器化部署
- **MySQL 8.0+**: 数据库
- **Redis 7+**: 缓存服务

## 🏃‍♂️ 快速开始

### 1. 克隆项目
```bash
git clone <repository-url>
cd chat2project
```

### 2. 配置环境变量
```bash
cp env.example .env
# 编辑 .env 文件设置配置
```

### 3. 启动服务
```bash
# 使用Docker Compose一键启动
docker-compose up -d
```

### 4. 访问应用
- **应用入口**: http://your-server:8080
- **API接口**: http://your-server:8080/api/...
- **静态文件**: http://your-server:8080/download/...

## 🔧 本地开发

### 启动后端服务
在IDEA中启动以下服务：
- **AiServer.java** (端口8031) - AI聊天服务
- **StaticServer.java** (端口9000) - 静态文件服务
- 在ai-chat resource下有建表sql

### 启动前端服务
```bash
# 安装依赖
cd ai-chat-frontend/aichat-frontend
pnpm install

# 启动开发服务器
pnpm serve
```

### 启动代理服务
```bash
cd ai-chat-frontend/aichat-node-proxy
npm install
node server.js
```

### 访问地址
- **前端**: http://localhost:3000
- **代理入口**: http://localhost:8080

## 🐳 Docker部署

### 构建镜像
```bash
# 构建最新版本
./build.sh latest

# 构建指定版本
./build.sh v1.0.0
```

### 配置环境变量
```bash
# 必须配置
PUBLIC_HOST=yourdomain.com:8080          # 公网访问地址
MYSQL_ROOT_PASSWORD=your_password         # 数据库密码

# 可选配置
MYSQL_DATABASE=ai_chat                   # 数据库名
MYSQL_USER=ai_user                       # 数据库用户
MYSQL_PASSWORD=ai_password               # 数据库密码
```

### 启动服务
```bash
# 后台启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## ⚙️ 配置说明

### 服务端口
- **8080**: 代理服务入口（对外暴露）
- **3000**: 前端服务
- **8031**: AI聊天服务
- **9000**: 静态文件服务
- **3306**: MySQL数据库
- **6379**: Redis缓存

### 环境变量详解
```bash
# 数据库配置
MYSQL_ROOT_PASSWORD=your_password         # MySQL root密码
MYSQL_DATABASE=ai_chat                   # 数据库名称
MYSQL_USER=ai_user                       # 数据库用户名
MYSQL_PASSWORD=ai_password               # 数据库密码

# 应用配置
PUBLIC_HOST=yourdomain.com:8080          # 公网访问地址
JWT_SECRET=your_jwt_secret               # JWT密钥

# AI服务配置
OPENAI_API_KEY=your_openai_key           # OpenAI API密钥
PINECONE_API_KEY=your_pinecone_key       # Pinecone API密钥
```

## 🔧 常用命令

### Docker命令
```bash
# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f ai-chat-app

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 进入容器
docker exec -it ai-chat-app /bin/bash

# 查看容器资源使用
docker stats
```

### 数据库操作
```bash
# 连接MySQL
docker exec -it ai-chat-mysql mysql -u root -p

# 备份数据库
docker exec ai-chat-mysql mysqldump -u root -p ai_chat > backup.sql

# 恢复数据库
docker exec -i ai-chat-mysql mysql -u root -p ai_chat < backup.sql
```

### 日志查看
```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs ai-chat-app

# 实时查看日志
docker-compose logs -f ai-chat-app

# 查看最近100行日志
docker-compose logs --tail=100 ai-chat-app
```

## 🛡️ 安全配置

### 防火墙设置
```bash
# 开放必要端口
sudo ufw allow 8080/tcp
sudo ufw allow 22/tcp

# 查看防火墙状态
sudo ufw status
```

### SSL证书配置
```bash
# 使用Let's Encrypt
sudo apt install certbot
sudo certbot certonly --standalone -d yourdomain.com

# 配置Nginx反向代理
# 参考nginx.conf配置
```

## 📊 监控和维护

### 健康检查
```bash
# 检查服务状态
curl http://localhost:8080/health

# 检查数据库连接
docker exec ai-chat-mysql mysqladmin ping -h localhost

# 检查Redis连接
docker exec ai-chat-redis redis-cli ping
```

### 性能监控
```bash
# 查看容器资源使用
docker stats

# 查看系统资源
htop
free -h
df -h
```

### 日志轮转
```bash
# 配置Docker日志轮转
# 在docker-compose.yml中添加：
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

## 🆘 故障排除

### 常见问题

#### 1. 端口被占用
```bash
# 检查端口占用
netstat -tlnp | grep 8080
lsof -i :8080

# 杀死占用进程
sudo kill -9 <PID>
```

#### 2. 数据库连接失败
```bash
# 检查MySQL状态
docker-compose logs ai-chat-mysql

# 重启数据库
docker-compose restart ai-chat-mysql

# 检查数据库配置
docker exec ai-chat-mysql mysql -u root -p -e "SHOW DATABASES;"
```

#### 3. 前端无法访问
```bash
# 检查代理服务
docker-compose logs aichat-node-proxy

# 检查前端服务
docker-compose logs aichat-frontend

# 重启服务
docker-compose restart aichat-node-proxy
```

#### 4. AI回复异常
```bash
# 检查AI服务日志
docker-compose logs ai-chat-app

# 检查API配置
docker exec ai-chat-app env | grep OPENAI

# 测试API连接
curl -X POST http://localhost:8080/api/chat/test
```

### 日志分析
```bash
# 查看错误日志
docker-compose logs | grep ERROR

# 查看警告日志
docker-compose logs | grep WARN

# 查看特定时间日志
docker-compose logs --since="2024-01-01T00:00:00"
```

## 🔄 更新部署

### 更新应用
```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
./build.sh latest

# 重启服务
docker-compose down
docker-compose up -d
```

### 数据备份
```bash
# 备份数据库
docker exec ai-chat-mysql mysqldump -u root -p ai_chat > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份上传文件
tar -czf static_files_$(date +%Y%m%d_%H%M%S).tar.gz static-files/
```

## 📞 技术支持

如遇到问题，请检查：
1. 环境变量配置是否正确
2. 端口是否被占用
3. 服务日志中的错误信息
4. 网络连接是否正常
5. 数据库和Redis服务是否正常

更多技术支持，请查看项目Issues或联系开发团队。
